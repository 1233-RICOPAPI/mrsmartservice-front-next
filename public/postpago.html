<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago aprobado</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:920px;margin:0 auto;padding:32px 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.07);padding:22px;margin:14px 0}
    .ok{display:flex;align-items:center;gap:12px}
    .badge{width:42px;height:42px;border-radius:999px;background:#e8fff1;display:grid;place-items:center;border:2px solid #40c057}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    a.btn,button.btn{border:0;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;font-weight:700}
    .btn-primary{background:#1f2937;color:#fff}
    .btn-ghost{background:#eef2ff;color:#1f2937}
    .muted{color:#6b7280;font-size:14px}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .field label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px;font-weight:600}
    .field input{width:100%;box-sizing:border-box;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;outline:none}
    .field input:focus{border-color:#94a3b8;background:#fff}
    @media (max-width:700px){.form-grid{grid-template-columns:1fr}}
  </style>

  <!-- Carga tu config para que window.API apunte al Cloud Run correcto -->
  <script src="js/app.config.js?v=49"></script>
  <script src="js/app.ui.js?v=50"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="ok">
        <div class="badge">‚úÖ</div>
        <div>
          <h2 style="margin:0">Procesando tu pago‚Ä¶</h2>
          <div class="muted" id="subtitle">Confirmando con Mercado Pago</div>
        </div>
      </div>
    </div>

    <div class="card" id="result" style="display:none">
      <h2 style="margin:0 0 6px; font-size:26px">‚úÖ Pago confirmado</h2>
      <div class="muted" id="meta"></div>
      <p class="muted" style="margin-top:12px">Tu factura mostrador est√° lista. Puedes descargarla, imprimirla o volver a la tienda. Si necesitas Factura ELC completa los datos al final.</p>

      <div class="btns" style="margin-top:14px">
        <a class="btn btn-primary" id="btnInvoice" href="#" target="_blank" rel="noopener" style="flex:1">
          üîΩ Descargar factura
        </a>
        <button class="btn btn-ghost" id="btnPrint" type="button" style="flex:1">üñ®Ô∏è Imprimir factura</button>
        <a class="btn btn-ghost" id="btnStore" href="index.html" style="flex:1">‚Ü©Ô∏è Volver a la tienda</a>
      </div>
      <div class="btns" style="margin-top:10px">
        <button class="btn" id="btnNeedInvoice" type="button" style="background:#111827;color:#fff;flex:1">üßæ Pedir Factura ELC</button>
      </div>

      <div id="billingBox" style="display:none; margin-top:14px">
        <div class="muted" style="margin-bottom:8px">Datos para facturaci√≥n (obligatorio para Factura ELC)</div>
        <div class="form-grid">
          <div class="field">
            <label for="billName">Nombre</label>
            <input id="billName" type="text" placeholder="Tu nombre" />
          </div>
          <div class="field">
            <label for="billNit">NIT / Raz√≥n social</label>
            <input id="billNit" type="text" placeholder="NIT o raz√≥n social" />
          </div>
          <div class="field">
            <label for="billEmail">Correo</label>
            <input id="billEmail" type="email" placeholder="correo@ejemplo.com" />
          </div>
          <div class="field">
            <label for="billTel">Tel√©fono</label>
            <input id="billTel" type="tel" placeholder="Ej: 3001234567" />
          </div>
        </div>
        <div class="btns" style="margin-top:12px">
          <button class="btn" id="btnSendELC" type="button" style="background:#16a34a;color:#fff;flex:1">Enviar solicitud ELC</button>
          <button class="btn btn-ghost" id="btnCancelInvoice" type="button">Cancelar</button>
        </div>
      </div>

      <div class="btns" style="margin-top:14px">
        <a class="btn btn-ghost" id="btnInvoiceCopy" href="#" target="_blank" rel="noopener">Abrir factura en nueva pesta√±a</a>
      </div>

      <div class="muted" style="margin-top:12px; display:none" id="invoiceLinkWrap">
        Si no se abre la factura, copia y pega este link: <br>
        <code id="invoiceText"></code>
      </div>
    </div>

    <div class="card" id="error" style="display:none">
      <h3 style="margin:0 0 8px;color:#b91c1c">No pudimos confirmar el pago</h3>
      <div class="muted" id="errText"></div>
      <div class="btns">
        <a class="btn btn-primary" href="carrito.html">Volver al carrito</a>
        <a class="btn btn-ghost" href="index.html">Ir a la tienda</a>
      </div>
    </div>
  </div>

<script>
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  function apiBase() {
    if (window.API) return window.API;
    return 'https://mrsmartservice-256100476140.us-central1.run.app/api';
  }

  async function confirmPago(payload) {
    const url = apiBase().replace(/\/$/, '') + '/payments/confirm';
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    let data = null;
    try {
      data = await res.json();
    } catch {
      data = { error: 'bad_response' };
    }
    if (!res.ok) {
      const err = new Error(data?.error || 'confirm_failed');
      err.data = data;
      throw err;
    }
    return data;
  }

  (async function main() {
    const paymentId = getParam('payment_id') || getParam('collection_id');
    const paymentStatus = (getParam('status') || getParam('collection_status') || '').toLowerCase();
    const subtitle = document.getElementById('subtitle');

    if (!paymentId) {
      document.getElementById('error').style.display = 'block';
      document.getElementById('errText').textContent = 'Falta payment_id en la URL. (Ej: ?payment_id=123)';
      subtitle.textContent = 'Faltan datos en la URL';
      return;
    }

    try {
      if (typeof showBusy === 'function') showBusy('Procesando pago‚Ä¶');
      if (paymentStatus && paymentStatus !== 'approved') {
        throw new Error(`Pago no aprobado: ${paymentStatus}`);
      }

      let last = null;
      try {
        last = JSON.parse(localStorage.getItem('mr_last_checkout') || 'null');
      } catch {
        last = null;
      }
      if (!last || !Array.isArray(last.items) || !last.items.length) {
        throw new Error('No encontramos los datos de la compra en este navegador. Vuelve al carrito e int√©ntalo de nuevo.');
      }

      const r = await confirmPago({
        payment_id: String(paymentId),
        status: 'approved',
        items: last.items,
        shipping: last.shipping || null,
      });
      subtitle.textContent = 'Pago confirmado ‚úÖ';
      if (typeof hideBusy === 'function') hideBusy();

      const invoiceUrl = r.invoice_url;
      const orderId = r.order_id;
      if (!invoiceUrl) throw new Error('invoice_url_missing');

      let invoiceToken = (() => {
        try {
          return new URL(invoiceUrl).searchParams.get('token') || '';
        } catch {
          return '';
        }
      })();

      try {
        localStorage.setItem('last_invoice_url', invoiceUrl);
        localStorage.setItem('last_order_id', String(orderId));
        localStorage.setItem('last_payment_id', String(paymentId));
        localStorage.setItem('last_invoice_at', new Date().toISOString());
        localStorage.removeItem('carrito');
        localStorage.removeItem('mr_last_checkout');
        localStorage.removeItem('carrito_entrega');
      } catch {}

      document.getElementById('result').style.display = 'block';
      document.getElementById('meta').innerHTML = `Orden <b>#${orderId}</b> ¬∑ Estado <b>${r.status}</b> ¬∑ Payment <b>${paymentId}</b>`;

      const btnInvoice = document.getElementById('btnInvoice');
      const btnInvoiceCopy = document.getElementById('btnInvoiceCopy');
      const btnPrint = document.getElementById('btnPrint');
      const btnStore = document.getElementById('btnStore');
      const invoiceText = document.getElementById('invoiceText');
      const invoiceLinkWrap = document.getElementById('invoiceLinkWrap');
      const billingBox = document.getElementById('billingBox');
      const btnNeedInvoice = document.getElementById('btnNeedInvoice');
      const btnCancelInvoice = document.getElementById('btnCancelInvoice');
      const btnSendELC = document.getElementById('btnSendELC');
      const billName = document.getElementById('billName');
      const billNit = document.getElementById('billNit');
      const billEmail = document.getElementById('billEmail');
      const billTel = document.getElementById('billTel');

      btnInvoice.href = invoiceUrl;
      btnInvoiceCopy?.addEventListener('click', (e) => {
        e.preventDefault();
        window.open(invoiceUrl, '_blank', 'noopener');
      });
      btnPrint?.addEventListener('click', (e) => {
        e.preventDefault();
        window.open(invoiceUrl, '_blank', 'noopener');
      });
      if (invoiceText) invoiceText.textContent = invoiceUrl;
      if (invoiceLinkWrap) invoiceLinkWrap.style.display = 'block';

      try {
        billName.value = localStorage.getItem('billing_name') || '';
        billNit.value = localStorage.getItem('billing_nit') || '';
        billEmail.value = localStorage.getItem('billing_email') || '';
        billTel.value = localStorage.getItem('billing_tel') || '';
      } catch {}
      const persistBilling = () => {
        try {
          localStorage.setItem('billing_name', (billName.value || '').trim());
          localStorage.setItem('billing_nit', (billNit.value || '').trim());
          localStorage.setItem('billing_email', (billEmail.value || '').trim());
          localStorage.setItem('billing_tel', (billTel.value || '').trim());
        } catch {}
      };
      [billName, billNit, billEmail, billTel].forEach((el) => {
        el.addEventListener('blur', persistBilling);
        el.addEventListener('change', persistBilling);
      });

      btnNeedInvoice?.addEventListener('click', (e) => {
        e.preventDefault();
        billingBox.style.display = 'block';
        billingBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      btnCancelInvoice?.addEventListener('click', (e) => {
        e.preventDefault();
        billingBox.style.display = 'none';
      });

      btnSendELC?.addEventListener('click', async (e) => {
        e.preventDefault();
        const payload = {
          name: (billName.value || '').trim(),
          nit: (billNit.value || '').trim(),
          email: (billEmail.value || '').trim(),
          phone: (billTel.value || '').trim(),
        };
        if (!payload.name || !payload.nit || !payload.email || !payload.phone) {
          alert('Completa Nombre, NIT, Correo y Tel√©fono para solicitar Factura ELC.');
          return;
        }
        try {
          const url = apiBase().replace(/\/$/, '') + `/invoices/${orderId}/billing?token=${encodeURIComponent(invoiceToken)}`;
          const res = await fetch(url, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.error || 'No se pudo registrar la solicitud.');
          if (data?.invoice_token) invoiceToken = data.invoice_token;
          alert('Solicitud de Factura ELC enviada. Te contactaremos cuando est√© lista.');
          billingBox.style.display = 'none';
        } catch (error) {
          alert(error.message || 'Error enviando la solicitud.');
        }
      });

    } catch (e) {
      subtitle.textContent = 'Error al confirmar ‚ùå';
      if (typeof hideBusy === 'function') hideBusy();
      document.getElementById('error').style.display = 'block';
      document.getElementById('errText').textContent = `${e.message} ${e.data ? JSON.stringify(e.data) : ''}`;
    }
  })();
</script>
</body>
</html>
