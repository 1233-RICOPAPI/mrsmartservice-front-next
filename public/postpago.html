<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago aprobado</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:920px;margin:0 auto;padding:32px 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.07);padding:22px;margin:14px 0}
    .ok{display:flex;align-items:center;gap:12px}
    .badge{width:42px;height:42px;border-radius:999px;background:#e8fff1;display:grid;place-items:center;border:2px solid #40c057}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    a.btn,button.btn{border:0;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;font-weight:700}
    .btn-primary{background:#1f2937;color:#fff}
    .btn-ghost{background:#eef2ff;color:#1f2937}
    .muted{color:#6b7280;font-size:14px}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .field label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px;font-weight:600}
    .field input{width:100%;box-sizing:border-box;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;outline:none}
    .field input:focus{border-color:#94a3b8;background:#fff}
    @media (max-width:700px){.form-grid{grid-template-columns:1fr}}
  </style>

  <!-- Carga tu config para que window.API apunte al Cloud Run correcto -->
  <script src="js/app.config.js?v=49"></script>
  <script src="js/app.ui.js?v=50"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="ok">
        <div class="badge">✅</div>
        <div>
          <h2 style="margin:0">Procesando tu pago…</h2>
          <div class="muted" id="subtitle">Confirmando con Mercado Pago</div>
        </div>
      </div>
    </div>

    <div class="card" id="result" style="display:none">
      <h3 style="margin:0 0 8px">Listo</h3>
      <div class="muted" id="meta"></div>

      <div style="margin-top:14px">
        <div class="muted" style="margin-bottom:8px">Datos para facturación (se enviarán por WhatsApp)</div>
        <div class="form-grid">
          <div class="field">
            <label for="billName">Nombre</label>
            <input id="billName" type="text" placeholder="Tu nombre" />
          </div>
          <div class="field">
            <label for="billNit">NIT / Razón social</label>
            <input id="billNit" type="text" placeholder="NIT o razón social" />
          </div>
          <div class="field">
            <label for="billEmail">Correo</label>
            <input id="billEmail" type="email" placeholder="correo@ejemplo.com" />
          </div>
          <div class="field">
            <label for="billTel">Teléfono</label>
            <input id="billTel" type="tel" placeholder="Ej: 3001234567" />
          </div>
        </div>
      </div>

      <div class="btns">
        <a class="btn btn-primary" id="btnInvoice" href="#" target="_blank" rel="noopener">Descargar factura</a>
        <a class="btn btn-ghost" id="btnWhats" href="#" target="_blank" rel="noopener">Pedir por WhatsApp</a>
        <a class="btn btn-ghost" id="btnStore" href="index.html">Volver a la tienda</a>
      </div>

      <div class="muted" style="margin-top:12px">
        Si no se abre la factura, copia y pega este link: <br>
        <code id="invoiceText"></code>
      </div>
    </div>

    <div class="card" id="error" style="display:none">
      <h3 style="margin:0 0 8px;color:#b91c1c">No pudimos confirmar el pago</h3>
      <div class="muted" id="errText"></div>
      <div class="btns">
        <a class="btn btn-primary" href="carrito.html">Volver al carrito</a>
        <a class="btn btn-ghost" href="index.html">Ir a la tienda</a>
      </div>
    </div>
  </div>

<script>
  function getParam(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function apiBase(){
    // window.API viene de app.config.js
    if (window.API) return window.API;
    // fallback (por si no cargó el config)
    // En producción, usa el mismo origen del front ("/api") y deja que Vercel
    // haga el rewrite hacia Cloud Run (ver vercel.json).
    return `${location.origin}/api`;
  }

  async function confirmPago(payload){
    const url = apiBase().replace(/\/$/, '') + '/payments/confirm';
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    let data = null;
    try { data = await res.json(); } catch (e) { data = { error: 'bad_response' }; }
    if (!res.ok) {
      const err = new Error(data?.error || 'confirm_failed');
      err.data = data;
      throw err;
    }
    return data;
  }

  // WhatsApp (pon aquí tu número con indicativo, sin +)
  const WHATS_PHONE = (window.WHATSAPP_INVOICE || window.WHATSAPP_BUSINESS || '573014190633').replace(/\D/g,'');

  // Construir mensaje WhatsApp con datos de la orden + productos + solicitud de datos fiscales
  async function buildWhatsMsg({ invoiceUrl, orderId, paymentId, statusFromConfirm, billing }){
    try{
      // Extraer token desde la URL de la factura (viene del backend)
      const u = new URL(invoiceUrl);
      const token = u.searchParams.get('token') || '';

      // Pedimos el JSON de la factura para sacar cliente + items + totales
      const inv = await (async () => {
        const url = apiBase().replace(/\/$/, '') + `/invoices/${encodeURIComponent(orderId)}?token=${encodeURIComponent(token)}`;
        const r2 = await fetch(url);
        if (!r2.ok) throw new Error('invoice_json_failed');
        return r2.json();
      })();

      const order = inv.order || {};
      const items = Array.isArray(inv.items) ? inv.items : [];

      const moneyCOP = (n) => {
        try { return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 }).format(Number(n||0)); }
        catch { return '$' + (Number(n||0)||0); }
      };

      const name  = order.customer_name || order.domicilio_nombre || 'Cliente';
      const email = order.customer_email || order.payer_email || order.email || '';
      const tel   = order.customer_phone || order.domicilio_telefono || '';
      const city  = order.customer_city || order.domicilio_ciudad || '';
      const addr  = order.customer_address || order.domicilio_direccion || '';

      // Helpers para decidir si es Villavicencio (sin acentos)
      const normalizarCiudad = (c) => String(c || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
      const esVillavicencio = (c) => normalizarCiudad(c) === 'villavicencio';

      const modo = String(order.domicilio_modo || '').toLowerCase();
      const shipCity = String(order.domicilio_ciudad || city || '').trim();
      const shipCost = Number(order.domicilio_costo || 0);

      // Texto de entrega para el admin
      let entrega = 'Entrega: Recoger en el local (MR SmartService - C.C. Los Centauros)';
      if (modo === 'domicilio') {
        if (esVillavicencio(shipCity) && shipCost > 0) {
          entrega = 'Entrega: Domicilio Villavicencio (+$7.000)';
        } else {
          entrega = 'Entrega: Contraentrega (fuera de Villavicencio, sin cobro de envío)';
        }
      }

      const lines = [];

      // Encabezado
      lines.push('Compra realizada ✅');
      lines.push(`Cliente: ${billing?.name || name || 'Cliente'}`);
      lines.push(`NIT/Razón social: ${billing?.nit || 'N/A'}`);
      lines.push(`Correo: ${billing?.email || email || ''}`);
      lines.push(`Tel: ${billing?.tel || tel || ''}`);
      lines.push('');

      lines.push('Detalles de la compra:');
      lines.push(`Orden #${orderId} · Pago ${paymentId} · Estado: ${order.status || statusFromConfirm}`);
      lines.push(entrega);

      // Nota rápida del cobro de envío
      if (modo === 'domicilio') {
        if (shipCost > 0) lines.push(`Domicilio: ${moneyCOP(shipCost)}`);
        else lines.push('Domicilio: $0 (contraentrega)');
      }

      // Datos de entrega
      if (modo === 'domicilio') {
        const dNombre = String(order.domicilio_nombre || '').trim();
        const dTel = String(order.domicilio_telefono || '').trim();
        const dDir = String(order.domicilio_direccion || '').trim();
        const dBarrio = String(order.domicilio_barrio || '').trim();
        const dNota = String(order.domicilio_nota || '').trim();

        if (dNombre) lines.push(`Contacto: ${dNombre}`);
        if (dTel) lines.push(`Tel entrega: ${dTel}`);
        if (shipCity) lines.push(`Ciudad: ${shipCity}`);
        if (dDir) lines.push(`Dirección: ${dDir}`);
        if (dBarrio) lines.push(`Barrio: ${dBarrio}`);
        if (dNota) lines.push(`Referencia: ${dNota}`);
      }

      if (items.length) {
        lines.push('--- Productos ---');
        let subtotal = 0;
        items.forEach((it, idx) => {
          const qty = Number(it.quantity || 0);
          const unit = Number(it.unit_price || 0);
          const totalLine = qty * unit;
          subtotal += totalLine;
          lines.push(`${idx+1}) ${it.name || ''} x${qty} · ${moneyCOP(unit)} · ${moneyCOP(totalLine)}`);
        });
        const ship = Number(order.domicilio_costo || 0);
        const total = Number(order.total_amount || (subtotal + ship));
        lines.push('--- Totales ---');
        lines.push(`Subtotal: ${moneyCOP(subtotal)}`);
        if (ship) lines.push(`Domicilio: ${moneyCOP(ship)}`);
        lines.push(`Total: ${moneyCOP(total)}`);
      }

      // ✅ Datos para facturación (se mandan ya llenos desde este formulario)
      // (se agregan arriba, antes de productos)

      return lines.join('\n');
    } catch (e) {
      // fallback simple (igual pide datos fiscales)
      return (
        `Compra realizada ✅
` +
        `Orden #${orderId} · Pago ${paymentId}.
` +
        `Cliente: ${billing?.name || ''}
` +
        `NIT/Razón social: ${billing?.nit || ''}
` +
        `Correo: ${billing?.email || ''}
` +
        `Tel: ${billing?.tel || ''}

` +
        `Factura: ${invoiceUrl}`
      );
    }
  }

  (async function main(){
    const paymentId = getParam('payment_id') || getParam('collection_id');
    const paymentStatus = (getParam('status') || getParam('collection_status') || '').toLowerCase();
    const subtitle = document.getElementById('subtitle');

    if (!paymentId) {
      document.getElementById('error').style.display = 'block';
      document.getElementById('errText').textContent = 'Falta payment_id en la URL. (Ej: ?payment_id=123)';
      subtitle.textContent = 'Faltan datos en la URL';
      return;
    }

    try {
      if (typeof showBusy === 'function') showBusy('Procesando pago…');
      if (paymentStatus && paymentStatus !== 'approved') {
        throw new Error(`Pago no aprobado: ${paymentStatus}`);
      }

      // Recuperar el checkout guardado desde carrito.html
      let last = null;
      try { last = JSON.parse(localStorage.getItem('mr_last_checkout') || 'null'); } catch (e) { last = null; }
      if (!last || !Array.isArray(last.items) || !last.items.length) {
        throw new Error('No encontramos los datos de la compra en este navegador (carrito/checkout). Vuelve al carrito e intenta de nuevo.');
      }

      const r = await confirmPago({
        payment_id: String(paymentId),
        status: 'approved',
        items: last.items,
        shipping: last.shipping || null,
      });
      subtitle.textContent = 'Pago confirmado ✅';
      if (typeof hideBusy === 'function') hideBusy();

      const invoiceUrl = r.invoice_url;
      const orderId = r.order_id;

      if (!invoiceUrl) throw new Error('invoice_url_missing');

      // Guarda para que en la tienda puedas mostrar "Última factura"
      try {
        localStorage.setItem('last_invoice_url', invoiceUrl);
        localStorage.setItem('last_order_id', String(orderId));
        localStorage.setItem('last_payment_id', String(paymentId));
        localStorage.setItem('last_invoice_at', new Date().toISOString());
      } catch (e) {}

      // Limpieza de carrito SOLO después de pago aprobado
      try {
        localStorage.removeItem('carrito');
        localStorage.removeItem('mr_last_checkout');
        localStorage.removeItem('carrito_entrega');
      } catch (e) {}

      // pinta UI
      document.getElementById('result').style.display = 'block';
      document.getElementById('meta').innerHTML = `Orden <b>#${orderId}</b> · Estado <b>${r.status}</b> · Payment <b>${paymentId}</b>`;

      const btnInvoice = document.getElementById('btnInvoice');
      btnInvoice.href = invoiceUrl;
      document.getElementById('invoiceText').textContent = invoiceUrl;


      // Prefill datos de facturación desde localStorage
      const billName = document.getElementById('billName');
      const billNit  = document.getElementById('billNit');
      const billEmail= document.getElementById('billEmail');
      const billTel  = document.getElementById('billTel');
      try {
        billName.value  = localStorage.getItem('billing_name')  || '';
        billNit.value   = localStorage.getItem('billing_nit')   || '';
        billEmail.value = localStorage.getItem('billing_email') || '';
        billTel.value   = localStorage.getItem('billing_tel')   || '';
      } catch (e) {}

      // Guardar datos al escribir (autocompletar próxima compra)
      const saveBilling = () => {
        try {
          localStorage.setItem('billing_name', (billName?.value || '').trim());
          localStorage.setItem('billing_nit', (billNit?.value || '').trim());
          localStorage.setItem('billing_email', (billEmail?.value || '').trim());
          localStorage.setItem('billing_tel', (billTel?.value || '').trim());
        } catch (e) {}
      };
      ;[billName, billNit, billEmail, billTel].forEach((el) => {
        if (!el) return;
        el.addEventListener('blur', saveBilling);
        el.addEventListener('change', saveBilling);
      });

      // ✅ IMPORTANTE: armar WhatsApp AL CLIC (evita caché y asegura el mensaje completo)
      const btnWhats = document.getElementById('btnWhats');
      btnWhats.addEventListener('click', async (ev) => {
        ev.preventDefault();
        btnWhats.textContent = 'Redirigiendo a WhatsApp...';
        if (typeof showBusy === 'function') showBusy('Redirigiendo a WhatsApp…');

        const billing = {
          name: (document.getElementById('billName')?.value || '').trim(),
          nit:  (document.getElementById('billNit')?.value || '').trim(),
          email:(document.getElementById('billEmail')?.value || '').trim(),
          tel:  (document.getElementById('billTel')?.value || '').trim(),
        };

        if (!billing.name || !billing.nit || !billing.email || !billing.tel){
          alert('Por favor completa: Nombre, NIT/Razón social, Correo y Teléfono.');
          btnWhats.textContent = 'Pedir por WhatsApp';
          if (typeof hideBusy === 'function') hideBusy();
          return;
        }

        // guardar para la próxima compra
        try {
          localStorage.setItem('billing_name', billing.name);
          localStorage.setItem('billing_nit', billing.nit);
          localStorage.setItem('billing_email', billing.email);
          localStorage.setItem('billing_tel', billing.tel);
        } catch (e) {}

        const msg = await buildWhatsMsg({
          invoiceUrl,
          orderId,
          paymentId,
          statusFromConfirm: r.status,
          billing
        });

        const url = `https://wa.me/${WHATS_PHONE}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank', 'noopener');

        // Ocultar loader después de abrir WhatsApp
        setTimeout(() => {
          if (typeof hideBusy === 'function') hideBusy();
        }, 600);

        btnWhats.textContent = 'Pedir por WhatsApp';
      });

    } catch (e) {
      subtitle.textContent = 'Error al confirmar ❌';
      if (typeof hideBusy === 'function') hideBusy();
      document.getElementById('error').style.display = 'block';
      document.getElementById('errText').textContent = `${e.message} ${e.data ? JSON.stringify(e.data) : ''}`;
    }
  })();
</script>
</body>
</html>
